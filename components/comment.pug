include /components/actionMenu.pug
include /components/atoms/userStatusBadge.pug
include /components/atoms/button.pug
include /components/reactions.pug
include /components/atoms/userRating.pug


mixin comment(commentID, userName, userID, status, commentText, reactions, color, url, review)

    - var initials = userName.split(' ').map(name => name[0]).join('').toUpperCase()
    .flex.flex-grow.gap-3.items-center.pt-2.pb-2
        +avatar(color, initials, '36', url)
        .flex.flex-col.gap-1
            if userName
                .flex.items-center.gap-2
                    a(href="" class="text-sm font-semibold leading-none") #{userName}
                    +userRating(342)

                .flex.items-center.gap-2
                    +userStatusBadge(status)
                    span(class="text-xs text-lab-black-50") @#{userID}
                    span(class="text-xs text-lab-black-50") 12 ноября 16:43

                if review 
                    .flex.shrink-0.items-center(class="mt-0.5")
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-empty.svg").h-4
            else
                .flex.items-center.gap-2
                    a(href="" class="text-sm font-semibold leading-none") @#{userID}
                    +userRating(342)
                .flex.items-center.gap-2
                    +userStatusBadge(status)
                    span(class="text-xs text-lab-black-50") 12 ноября 16:43
                if review 
                    .flex.shrink-0.items-center(class="mt-0.5")
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-full.svg").h-4
                        img(src="img/yellow-star-empty.svg").h-4
    .flex.items-center.gap-1.px-2.py-1.bg-lab-color-10.w-fit.rounded-lg.mt-1.mb-2     
        img(src="img/reply.svg" class="size-3 saturate-50 opacity-75")
        span.text-xs.text-lab-black-50 Ответ на комментарий @semenov
    p #{commentText}
    +reactions(reactions, 0)
    div.flex.justify-between.pt-1.pb-3
        div(class="relative inline-flex gap-2 items-center")
            img(src="img/reactions.svg" alt="Reactions" class="cursor-pointer" id=`reactions-trigger-${commentID}`)
            button.text-sm.text-lab-black-50(onclick=`toggleCommentForm('${commentID}')`) Ответить
            div(class="absolute bottom-6 -left-2 hidden max-w-[80vw]" id=`reactions-popup-${commentID}`)
                div(class="flex p-2 bg-white rounded-full overflow-x-auto no-scrollbar gap-2 border border-lab-black-10 text-xl shadow-lg")
                    each reaction in reactions
                        button(class="px-2 bg-slate-100 rounded-full" onclick=`togglePopup(${commentID})`) #{reaction.emoji}
        img(src='img/three-dots.svg', onclick=`toggleCommentMenu('${commentID}')`, class="cursor-pointer")
        //- Меню комментария
        div(id=`commentMenu-${commentID}`, class="absolute bottom-0")
            +actionMenu([
                { text: 'Редактировать', icon: 'img/edit.svg', color: ' text-lab-color' },
                { text: 'Скопировать', icon: 'img/copy.svg', color: ' text-lab-color' },
                { text: 'Вырезать', icon: 'img/cut.svg', color: ' text-lab-color'},
                { text: 'Игнорировать', icon: 'img/hide.svg', color: ' text-lab-color' },
                { text: 'Скрыть', icon: 'img/hide.svg', color: ' text-lab-color' },
                { text: 'Пожаловаться', icon: 'img/warning.svg', color: ' text-lab-color' },
                { text: 'Удалить', icon: 'img/delete.svg', color: ' text-lab-red', last: true }
            ], 'action-menu-container')
    div.flex.flex-col.flex-grow.gap-3.mb-3(id=`commentForm-${commentID}` class="hidden")
        textarea(class="resize-none border rounded-md border-gray-300 p-2 transition-all duration-300 ease-in-out focus:outline-none focus:border-blue-500 overflow-hidden" style="scrollbar-width: none; -ms-overflow-style: none;" rows="1" placeholder="Напишите комментарий..." onfocus="this.rows=5; this.style.overflow='hidden'; document.getElementById('commentSubmitButton-${commentID}').classList.remove('hidden'); document.getElementById('cancelButton-${commentID}').classList.remove('hidden');" oninput="document.getElementById('commentSubmitButton-${commentID}').disabled = this.value.trim().length <= 1; this.style.height = ''; this.style.height = this.scrollHeight + 'px'; if(this.value.trim().length) { document.getElementById('commentSubmitButton-${commentID}').classList.remove('hidden'); document.getElementById('cancelButton-${commentID}').classList.remove('hidden'); } else { document.getElementById('commentSubmitButton-${commentID}').classList.add('hidden'); document.getElementById('cancelButton-${commentID}').classList.add('hidden'); }" onblur="if(!this.value.trim()) {this.rows=1; this.style.height = 'auto'; this.style.overflow='hidden'; document.getElementById('commentSubmitButton-${commentID}').classList.add('hidden'); document.getElementById('cancelButton-${commentID}').classList.add('hidden');}")
        .flex.items-center.gap-4
            +button('Отмена', 'text', 'lab-black-50', '', ' w-1/2', 'cancelButton')
            +button('Отправить', 'default', 'white', 'bg-lab-color', ' w-1/2', 'commentSubmitButton')
    script.
        function togglePopup(commentID) {
            var popup = document.getElementById(`reactions-popup-${commentID}`);
            var isDisplayed = popup.style.display === 'block';
            popup.style.display = isDisplayed ? 'none' : 'block';
        }

        document.getElementById(`reactions-trigger-${'#{commentID}'}`).addEventListener('click', function() {
            togglePopup('#{commentID}');
        });

        function toggleCommentMenu(commentID) {
            var commentMenu = document.getElementById(`action-menu-container`);
            console.log(commentMenu)
            commentMenu.classList.toggle('hidden');
        }

        function toggleCommentForm(commentID) {
            var form = document.getElementById(`commentForm-${commentID}`);
            form.classList.toggle('hidden');

        }